<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .loading { color: #666; font-style: italic; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #1f2937; }
        .stat-label { color: #6b7280; font-size: 14px; }
        pre { background: #f1f5f9; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; }
        .btn { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2563eb; }
    </style>
</head>
<body>
    <h1>🔧 Dashboard Integration Test</h1>
    <p>Testing real-data dashboard components with live API integration</p>

    <div class="test-section">
        <h2>🔐 Authentication Test</h2>
        <div id="auth-status" class="loading">Testing authentication...</div>
        <button class="btn" onclick="testAuth()">Retry Auth Test</button>
    </div>

    <div class="test-section">
        <h2>📊 Dashboard Statistics</h2>
        <div id="stats-status" class="loading">Loading dashboard statistics...</div>
        <div id="stats-display" class="stats"></div>
        <button class="btn" onclick="loadDashboardStats()">Reload Stats</button>
    </div>

    <div class="test-section">
        <h2>🧪 Individual API Services</h2>
        <div id="services-status" class="loading">Testing individual services...</div>
        <div id="services-results"></div>
        <button class="btn" onclick="testAllIndividualServices()">Test All Services</button>
    </div>

    <div class="test-section">
        <h2>📅 Recent Activities & Events</h2>
        <div id="activities-status" class="loading">Loading recent activities...</div>
        <div id="activities-display"></div>
        <button class="btn" onclick="loadRecentActivities()">Reload Activities</button>
    </div>

    <div class="test-section">
        <h2>📋 Test Results Log</h2>
        <pre id="test-log"></pre>
        <button class="btn" onclick="clearLog()">Clear Log</button>
    </div>

    <script type="module">
        // Import our API service
        import apiService from './src/services/apiService.js';
        
        // Make apiService available globally for testing
        window.apiService = apiService;

        let testLog = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            document.getElementById('test-log').textContent = testLog.join('\n');
            console.log(logEntry);
        }

        window.clearLog = () => {
            testLog = [];
            document.getElementById('test-log').textContent = '';
        };

        // Authentication test
        window.testAuth = async () => {
            const statusEl = document.getElementById('auth-status');
            try {
                statusEl.innerHTML = '<span class="loading">Testing authentication...</span>';
                log('🔐 Testing authentication...');

                // Try to access a protected endpoint
                const response = await fetch('http://localhost:3001/api/student');
                const result = await response.json();

                if (result.code === 'MISSING_TOKEN') {
                    statusEl.innerHTML = '<span class="success">✅ Backend is running, authentication required (expected)</span>';
                    log('✅ Backend authentication working correctly');
                    return true;
                } else {
                    statusEl.innerHTML = '<span class="error">❌ Unexpected auth response</span>';
                    log('❌ Unexpected authentication response');
                    return false;
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="error">❌ Connection failed: ${error.message}</span>`;
                log(`❌ Auth test failed: ${error.message}`);
                return false;
            }
        };

        // Dashboard statistics test
        window.loadDashboardStats = async () => {
            const statusEl = document.getElementById('stats-status');
            const displayEl = document.getElementById('stats-display');
            
            try {
                statusEl.innerHTML = '<span class="loading">Loading dashboard statistics...</span>';
                displayEl.innerHTML = '';
                log('📊 Loading dashboard statistics...');

                // Mock some authentication for testing (you may need to implement proper auth)
                // For now, let's see what we can access
                
                const [
                    students,
                    teachers,
                    theories,
                    orchestras,
                    rehearsals
                ] = await Promise.allSettled([
                    apiService.students.getStudents().catch(e => ({ error: e.message })),
                    apiService.teachers.getTeachers().catch(e => ({ error: e.message })),
                    apiService.theory.getTheoryLessons().catch(e => ({ error: e.message })),
                    apiService.orchestras.getOrchestras().catch(e => ({ error: e.message })),
                    apiService.rehearsals.getRehearsals().catch(e => ({ error: e.message }))
                ]);

                const stats = {
                    students: students.status === 'fulfilled' ? 
                        (Array.isArray(students.value) ? students.value.length : 'Auth Required') : 
                        `Error: ${students.reason?.message || 'Failed'}`,
                    teachers: teachers.status === 'fulfilled' ? 
                        (Array.isArray(teachers.value) ? teachers.value.length : 'Auth Required') : 
                        `Error: ${teachers.reason?.message || 'Failed'}`,
                    theories: theories.status === 'fulfilled' ? 
                        (Array.isArray(theories.value) ? theories.value.length : 'Auth Required') : 
                        `Error: ${theories.reason?.message || 'Failed'}`,
                    orchestras: orchestras.status === 'fulfilled' ? 
                        (Array.isArray(orchestras.value) ? orchestras.value.length : 'Auth Required') : 
                        `Error: ${orchestras.reason?.message || 'Failed'}`,
                    rehearsals: rehearsals.status === 'fulfilled' ? 
                        (Array.isArray(rehearsals.value) ? rehearsals.value.length : 'Auth Required') : 
                        `Error: ${rehearsals.reason?.message || 'Failed'}`
                };

                displayEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.students}</div>
                        <div class="stat-label">תלמידים</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.teachers}</div>
                        <div class="stat-label">מורים</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.theories}</div>
                        <div class="stat-label">שיעורי תאוריה</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.orchestras}</div>
                        <div class="stat-label">תזמורות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.rehearsals}</div>
                        <div class="stat-label">חזרות</div>
                    </div>
                `;

                const hasAuthErrors = Object.values(stats).some(s => typeof s === 'string' && s.includes('Auth Required'));
                if (hasAuthErrors) {
                    statusEl.innerHTML = '<span class="error">⚠️ API services require authentication</span>';
                    log('⚠️ Dashboard services require authentication - this is expected');
                } else {
                    statusEl.innerHTML = '<span class="success">✅ Dashboard statistics loaded successfully</span>';
                    log('✅ Dashboard statistics loaded from real APIs');
                }

                log(`📊 Stats loaded: Students: ${stats.students}, Teachers: ${stats.teachers}, Theories: ${stats.theories}`);

            } catch (error) {
                statusEl.innerHTML = `<span class="error">❌ Failed to load: ${error.message}</span>`;
                log(`❌ Dashboard stats failed: ${error.message}`);
            }
        };

        // Test individual services
        window.testAllIndividualServices = async () => {
            const statusEl = document.getElementById('services-status');
            const resultsEl = document.getElementById('services-results');
            
            statusEl.innerHTML = '<span class="loading">Testing all API services...</span>';
            resultsEl.innerHTML = '';
            log('🧪 Testing individual API services...');

            const services = ['students', 'teachers', 'theory', 'orchestras', 'rehearsals', 'schoolYears', 'bagrut', 'schedule'];
            const results = [];

            for (const serviceName of services) {
                try {
                    log(`Testing ${serviceName} service...`);
                    const service = apiService[serviceName];
                    
                    if (!service) {
                        results.push({ name: serviceName, status: 'Missing', error: 'Service not found' });
                        continue;
                    }

                    // Try to call the main get method for each service
                    let data;
                    if (serviceName === 'students') data = await service.getStudents().catch(e => ({ error: e }));
                    else if (serviceName === 'teachers') data = await service.getTeachers().catch(e => ({ error: e }));
                    else if (serviceName === 'theory') data = await service.getTheoryLessons().catch(e => ({ error: e }));
                    else if (serviceName === 'orchestras') data = await service.getOrchestras().catch(e => ({ error: e }));
                    else if (serviceName === 'rehearsals') data = await service.getRehearsals().catch(e => ({ error: e }));
                    else if (serviceName === 'schoolYears') data = await service.getSchoolYears().catch(e => ({ error: e }));
                    else if (serviceName === 'bagrut') data = await service.getBagruts().catch(e => ({ error: e }));
                    else if (serviceName === 'schedule') data = await service.getLessons().catch(e => ({ error: e }));

                    if (data && data.error) {
                        results.push({ 
                            name: serviceName, 
                            status: 'Auth Required', 
                            note: 'Expected - requires authentication' 
                        });
                    } else if (Array.isArray(data)) {
                        results.push({ 
                            name: serviceName, 
                            status: 'Success', 
                            count: data.length 
                        });
                    } else {
                        results.push({ 
                            name: serviceName, 
                            status: 'Unknown', 
                            data: typeof data 
                        });
                    }

                } catch (error) {
                    results.push({ 
                        name: serviceName, 
                        status: 'Error', 
                        error: error.message 
                    });
                    log(`❌ ${serviceName} service error: ${error.message}`);
                }
            }

            // Display results
            resultsEl.innerHTML = results.map(r => `
                <div class="stat-card">
                    <div class="stat-value ${r.status === 'Success' ? 'success' : r.status === 'Auth Required' ? '' : 'error'}">
                        ${r.status}
                    </div>
                    <div class="stat-label">${r.name}</div>
                    ${r.count ? `<div style="font-size: 12px; color: #666;">Count: ${r.count}</div>` : ''}
                    ${r.note ? `<div style="font-size: 12px; color: #666;">${r.note}</div>` : ''}
                    ${r.error ? `<div style="font-size: 12px; color: #ef4444;">${r.error}</div>` : ''}
                </div>
            `).join('');

            const successCount = results.filter(r => r.status === 'Success' || r.status === 'Auth Required').length;
            statusEl.innerHTML = `<span class="success">✅ Tested ${results.length} services, ${successCount} working correctly</span>`;
            log(`✅ Service tests completed: ${successCount}/${results.length} working`);
        };

        // Load recent activities
        window.loadRecentActivities = async () => {
            const statusEl = document.getElementById('activities-status');
            const displayEl = document.getElementById('activities-display');
            
            try {
                statusEl.innerHTML = '<span class="loading">Loading recent activities...</span>';
                displayEl.innerHTML = '';
                log('📅 Testing recent activities and events...');

                // Test if our dashboard analytics service works
                if (window.dashboardAnalytics) {
                    const events = await dashboardAnalytics.getUpcomingEvents().catch(e => ({ error: e.message }));
                    if (events.error) {
                        displayEl.innerHTML = `<p>⚠️ Events require authentication: ${events.error}</p>`;
                    } else {
                        displayEl.innerHTML = `<p>✅ Found ${events.length} upcoming events</p>`;
                    }
                } else {
                    displayEl.innerHTML = '<p>⚠️ Dashboard analytics not available - requires authentication</p>';
                }

                statusEl.innerHTML = '<span class="success">✅ Activities component tested</span>';
                log('✅ Activities and events component tested');

            } catch (error) {
                statusEl.innerHTML = `<span class="error">❌ Failed: ${error.message}</span>`;
                log(`❌ Activities test failed: ${error.message}`);
            }
        };

        // Initialize tests
        document.addEventListener('DOMContentLoaded', async () => {
            log('🚀 Starting dashboard integration tests...');
            
            await testAuth();
            await loadDashboardStats();
            await testAllIndividualServices();
            await loadRecentActivities();
            
            log('✅ All initial tests completed');
        });
    </script>
</body>
</html>